#include <WiFi.h>
#include <WiFiClientSecure.h>
#include <HTTPClient.h>
#include <WebServer.h>
#include <ArduinoJson.h>

/* ===== WiFi è¨­å®š ===== */
const char* ssid = "rayui";
const char* password = "btxu5549";

/* ===== API URL ===== */
String cwaUrl =
  "https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001?format=JSON&Authorization=CWA-0A7B9743-AD48-4D5D-B0E9-95EE6380A1E3";

String aqiBaseUrl =
  "https://data.moenv.gov.tw/api/v2/aqx_p_488?api_key=bccbe9ea-82d6-4a9c-af55-5d4b8a2872c2&format=JSON&limit=50";

/* ===== Web Server ===== */
WebServer server(80);

/* ===== å°ç£ç¸£å¸‚ ===== */
String cities[22] = {
  "è‡ºåŒ—å¸‚", "æ–°åŒ—å¸‚", "æ¡ƒåœ’å¸‚", "è‡ºä¸­å¸‚", "è‡ºå—å¸‚", "é«˜é›„å¸‚",
  "åŸºéš†å¸‚", "æ–°ç«¹å¸‚", "å˜‰ç¾©å¸‚",
  "æ–°ç«¹ç¸£", "è‹—æ —ç¸£", "å½°åŒ–ç¸£", "å—æŠ•ç¸£", "é›²æ—ç¸£",
  "å˜‰ç¾©ç¸£", "å±æ±ç¸£", "å®œè˜­ç¸£", "èŠ±è“®ç¸£", "è‡ºæ±ç¸£",
  "æ¾æ¹–ç¸£", "é‡‘é–€ç¸£", "é€£æ±Ÿç¸£"
};

/* ===== å¤©æ°£è³‡æ–™ ===== */
String wx = "ç„¡è³‡æ–™", pop = "0", minT = "--", maxT = "--", weatherIcon = "?", clothingAdvice = "ç„¡è³‡æ–™";
float apparentTemp = 0.0;
String comfortText = "ç„¡è³‡æ–™";

/* ===== AQI è³‡æ–™ ===== */
struct AQIRecord {
  String sitename;
  int aqi;
  String status;
  String time;
};

#define MAX_STATIONS 50
AQIRecord aqiRecords[MAX_STATIONS];
int aqiCount = 0;

/* ===== LED è¨­å®š ===== */
#define RGB_LED_PIN 48
void setLEDColor(uint8_t r, uint8_t g, uint8_t b) {
  neopixelWrite(RGB_LED_PIN, r, g, b);
}
void updateLEDByAQI(int aqi) {
  if (aqi <= 50) setLEDColor(0, 255, 0);
  else if (aqi <= 100) setLEDColor(255, 255, 0);
  else if (aqi <= 150) setLEDColor(255, 165, 0);
  else if (aqi <= 200) setLEDColor(255, 0, 0);
  else if (aqi <= 300) setLEDColor(128, 0, 128);
  else setLEDColor(139, 69, 19);
}

/* ===== WiFi ===== */
bool wifiConnected = false;
void init_wifi() {

  WiFi.mode(WIFI_STA);
  Serial.printf("Connecting to WiFi: %s ...\n", ssid);
  WiFi.begin(ssid, password);

  int retry = 0;
  while (WiFi.status() != WL_CONNECTED && retry < 30) {
    delay(500);
    Serial.print(".");
    retry++;
  }

  if (WiFi.status() == WL_CONNECTED) {
    wifiConnected = true;
    Serial.println("\nWiFi Connected!");
    Serial.print("IP Address: ");
    Serial.println(WiFi.localIP());
  } else {
    wifiConnected = false;
    Serial.println("\nWiFi Connection Failed!");
  }
}

/* ===== å¤©æ°£ icon ===== */
String getWeatherIcon(String wx) {
  if (wx.indexOf("é›·") >= 0) return "â›ˆï¸";
  if (wx.indexOf("é›¨") >= 0) return "ğŸŒ§ï¸";
  if (wx.indexOf("æ™´") >= 0 && wx.indexOf("é›²") >= 0) return "â›…";
  if (wx.indexOf("æ™´") >= 0) return "â˜€ï¸";
  return "â˜ï¸";
}

/* ===== ç©¿æ­å»ºè­° ===== */
String getClothingAdvice(int minT, int maxT, int pop) {
  String advice;
  if (minT < 15) advice = "åšå¤–å¥—";
  else if (minT < 20) advice = "è¨˜å¾—ç©¿å¤–å¥—";
  else if (maxT <= 28) advice = "çŸ­è¢–å³å¯";
  else advice = "æ¸…æ¶¼ç©¿è‘—";
  if (pop >= 50) advice += "ï¼Œè¨˜å¾—å¸¶é›¨å…· â˜”";
  return advice;
}

/* ===== èˆ’é©åº¦åˆ¤æ–· ===== */
String getComfort(float apparent) {
  if (apparent < 15) return "å¯’å†· â„ï¸";
  else if (apparent < 22) return "æ¶¼çˆ½ ğŸŒ¬ï¸";
  else if (apparent < 28) return "èˆ’é© ğŸ˜Œ";
  else return "ç‚ç†± ğŸ”¥";
}

/* ===== æŠ“å¤©æ°£ ===== */
void getWeather(String city) {
  wx = "ç„¡è³‡æ–™";
  pop = "0";
  minT = "--";
  maxT = "--";
  weatherIcon = "?";
  clothingAdvice = "ç„¡è³‡æ–™";
  apparentTemp = 0;
  comfortText = "ç„¡è³‡æ–™";

  WiFiClientSecure client;
  client.setInsecure();
  HTTPClient http;

  if (!http.begin(client, cwaUrl)) return;
  if (http.GET() != HTTP_CODE_OK) {
    http.end();
    return;
  }

  DynamicJsonDocument doc(40 * 1024);
  deserializeJson(doc, http.getString());
  http.end();

  for (JsonObject loc : doc["records"]["location"].as<JsonArray>()) {
    if (loc["locationName"].as<String>() == city) {
      String wxVal = "", popVal = "", minVal = "", maxVal = "";
      for (JsonObject e : loc["weatherElement"].as<JsonArray>()) {
        String n = e["elementName"];
        String v = e["time"][0]["parameter"]["parameterName"].as<String>();
        if (n == "Wx") wxVal = v;
        if (n == "PoP") popVal = v;
        if (n == "MinT") minVal = v;
        if (n == "MaxT") maxVal = v;
      }
      wx = wxVal;
      pop = popVal;
      minT = minVal;
      maxT = maxVal;
      weatherIcon = getWeatherIcon(wx);
      clothingAdvice = getClothingAdvice(minT.toInt(), maxT.toInt(), pop.toInt());
      apparentTemp = (minT.toInt() + maxT.toInt()) / 2.0; 
      comfortText = getComfort(apparentTemp);
      return;
    }
  }
}

/* ===== æŠ“ AQI ===== */
void getAQI(String city) {
  aqiCount = 0;
  WiFiClientSecure client;
  client.setInsecure();
  HTTPClient http;

  String url = aqiBaseUrl + "&filters=County,EQ," + city;
  if (!http.begin(client, url)) return;
  if (http.GET() != HTTP_CODE_OK) {
    http.end();
    return;
  }

  DynamicJsonDocument doc(80 * 1024);
  deserializeJson(doc, http.getString());
  http.end();

  JsonArray records = doc["records"].as<JsonArray>();

  for (JsonObject r : records) {
    String site = r["sitename"].as<String>();
    String time = r["datacreationdate"].as<String>();
    int idx = -1;
    for (int i = 0; i < aqiCount; i++)
      if (aqiRecords[i].sitename == site) idx = i;

    if (idx == -1 && aqiCount < MAX_STATIONS) {
      aqiRecords[aqiCount++] = { site, r["aqi"].as<int>(), r["status"].as<String>(), time };
    } else if (idx != -1 && time > aqiRecords[idx].time) {
      aqiRecords[idx].aqi = r["aqi"].as<int>();
      aqiRecords[idx].status = r["status"].as<String>();
      aqiRecords[idx].time = time;
    }
  }
}

/* ===== æ‰¾æœ€æ–° AQI ===== */
int getLatestAQI() {
  if (aqiCount == 0) return -1;
  int latest = 0;
  for (int i = 1; i < aqiCount; i++)
    if (aqiRecords[i].time > aqiRecords[latest].time)
      latest = i;
  return aqiRecords[latest].aqi;
}

/* ===== ä¸»é  ===== */
void handleRoot() {
  String html = "<!DOCTYPE html><html lang='zh-TW'><head>"
                "<meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>"
                "<title>å°ç£å¤©æ°£</title>"
                "<style>"
                "body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#e3f2fd,#f4f6f8);margin:0;padding:10px;} "
                "h2{text-align:center} "
                ".card{background:#fff;border-radius:14px;padding:14px;margin-top:10px;box-shadow:0 4px 10px rgba(0,0,0,.12);} "
                "select{width:100%;padding:10px;font-size:16px;border-radius:10px;text-align:center;text-align-last:center;} "
                "option{text-align:center;} "
                ".weather-main{text-align:center;font-size:22px;} "
                ".weather-sub{text-align:center;color:#555;} "
                "table{width:100%;border-collapse:collapse;margin-top:8px;} "
                "th,td{border:1px solid #ccc;padding:6px;text-align:center;} "
                "th{background:#eceff1;} "
                ".selected{outline:2px solid #2196F3;} "
                "</style></head><body>"
                "<h2>ğŸŒ¤ï¸ å°ç£å¤©æ°£</h2>"
                "<div class='card'><b>WiFi ç‹€æ…‹: </b>"
                + String(wifiConnected ? "å·²é€£ç·š" : "æœªé€£ç·š") + "</div>"
                                                                "<div class='card'><select id='citySel' onchange='updateAll()'>";

  for (int i = 0; i < 22; i++) html += "<option>" + cities[i] + "</option>";
  html += "</select></div><div class='card' id='weather'></div><div class='card' id='aqi'></div>"
          "<script>"
          "function aqiColor(a){if(a<=50)return'#4caf50';if(a<=100)return'#ffeb3b';if(a<=150)return'#ff9800';if(a<=200)return'#f44336';return'#9c27b0';}"
          "function updateAll(){fetch('/data?city='+citySel.value).then(r=>r.json()).then(d=>{"
          "weather.innerHTML=`<div class='weather-main'>${d.icon} ${d.wx}</div><div class='weather-sub'>ğŸŒ¡ï¸ ${d.minT}~${d.maxT}Â°C<br>ğŸ‘• ${d.clothing}<br> èˆ’é©åº¦: ${d.comfort}<br>é«”æ„Ÿ: ${d.apparentTemp}Â°C</div>`;"
          "let t='<table><tr><th>æª¢æ¸¬ç«™</th><th>AQI</th><th>ç‹€æ…‹</th><th>æ™‚é–“</th></tr>';"
          "d.aqiRecords.forEach((rec,i)=>{let c=aqiColor(rec.aqi);t+=`<tr id=row${i} onclick=selectRow(${i})><td>${rec.sitename}</td><td style=background:${c}>${rec.aqi}</td><td>${rec.status}</td><td>${rec.time}</td></tr>`;});"
          "aqi.innerHTML=t+'</table>'; window.data=d;"
          "if(d.aqiCount>0){let latestIndex=0;for(let j=1;j<d.aqiCount;j++)if(d.aqiRecords[j].time>d.aqiRecords[latestIndex].time)latestIndex=j;setTimeout(()=>{selectRow(latestIndex,true);},50);} "
          "})}"
          "function selectRow(index,init=false){if(!window.data)return;"
          "document.querySelectorAll('tr').forEach(r=>r.classList.remove('selected'));"
          "document.getElementById('row'+index).classList.add('selected');"
          "if(!init)fetch('/led?index='+index);}"
          "window.onload=updateAll;"
          "</script></body></html>";

  server.send(200, "text/html", html);
}

/* ===== API ===== */
void handleData() {
  String city = server.arg("city");
  getWeather(city);
  getAQI(city);

  int latestAQI = getLatestAQI();
  if (latestAQI != -1) updateLEDByAQI(latestAQI);

  String json = "{";
  json += "\"wx\":\"" + wx + "\",\"icon\":\"" + weatherIcon + "\",";
  json += "\"minT\":\"" + minT + "\",\"maxT\":\"" + maxT + "\",";
  json += "\"clothing\":\"" + clothingAdvice + "\",";
  json += "\"apparentTemp\":\"" + String(apparentTemp, 1) + "\",";
  json += "\"comfort\":\"" + comfortText + "\",";
  json += "\"aqiCount\":" + String(aqiCount) + ",\"aqiRecords\":[";
  for (int i = 0; i < aqiCount; i++) {
    if (i) json += ",";
    json += "{\"sitename\":\"" + aqiRecords[i].sitename + "\",\"aqi\":" + String(aqiRecords[i].aqi) + ",\"status\":\"" + aqiRecords[i].status + "\",\"time\":\"" + aqiRecords[i].time + "\"}";
  }
  json += "]}";
  server.send(200, "application/json", json);
}

/* ===== LED API ===== */
void handleLED() {
  if (!server.hasArg("index")) {
    server.send(400, "text/plain", "Missing index");
    return;
  }
  int idx = server.arg("index").toInt();
  if (idx < 0 || idx >= aqiCount) {
    server.send(400, "text/plain", "Invalid index");
    return;
  }
  updateLEDByAQI(aqiRecords[idx].aqi);
  server.send(200, "text/plain", "OK");
}

/* ===== setup / loop ===== */
void setup() {
  Serial.begin(115200);
  init_wifi();
  server.on("/", handleRoot);
  server.on("/data", handleData);
  server.on("/led", handleLED);
  server.begin();
}

void loop() {
  server.handleClient();
}
