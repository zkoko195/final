#include <WiFi.h>
#include <WiFiClientSecure.h>
#include <HTTPClient.h>
#include <WebServer.h>
#include <ArduinoJson.h>

/* ========= WiFi ========= */
const char* ssid = "rayui";
const char* password = "btxu5549";

/* ========= CWA API ========= */
String apiKey = "CWA-0A7B9743-AD48-4D5D-B0E9-95EE6380A1E3";
String baseUrl =
"https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001"
"?format=JSON&Authorization=" + apiKey;

/* ========= WebServer ========= */
WebServer server(80);

/* ========= Âè∞ÁÅ£ 22 Á∏£Â∏Ç ========= */
String locationNames[22] = {
  "Ëá∫ÂåóÂ∏Ç","Êñ∞ÂåóÂ∏Ç","Ê°ÉÂúíÂ∏Ç","Ëá∫‰∏≠Â∏Ç","Ëá∫ÂçóÂ∏Ç","È´òÈõÑÂ∏Ç",
  "Âü∫ÈöÜÂ∏Ç","Êñ∞Á´πÂ∏Ç","ÂòâÁæ©Â∏Ç",
  "Êñ∞Á´πÁ∏£","ËãóÊ†óÁ∏£","ÂΩ∞ÂåñÁ∏£","ÂçóÊäïÁ∏£","Èõ≤ÊûóÁ∏£",
  "ÂòâÁæ©Á∏£","Â±èÊù±Á∏£","ÂÆúËò≠Á∏£","Ëä±ËìÆÁ∏£","Ëá∫Êù±Á∏£",
  "ÊæéÊπñÁ∏£","ÈáëÈñÄÁ∏£","ÈÄ£Ê±üÁ∏£"
};

/* ========= Â§©Ê∞£Ë≥áÊñô ========= */
String wx, pop, minT, maxT;
String weatherIcon, clothingAdvice;

/* ========= WiFi ========= */
void initWiFi() {
  WiFi.begin(ssid, password);
  Serial.print("Connecting WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nWiFi connected");
  Serial.println(WiFi.localIP());
}

/* ========= Â§©Ê∞£ icon ========= */
String getWeatherIcon(String wx) {
  if (wx.indexOf("Èõ∑") >= 0) return "‚õàÔ∏è";
  if (wx.indexOf("Èõ®") >= 0) return "üåßÔ∏è";
  if (wx.indexOf("Êô¥") >= 0 && wx.indexOf("Èõ≤") >= 0) return "‚õÖ";
  if (wx.indexOf("Êô¥") >= 0) return "‚òÄÔ∏è";
  return "‚òÅÔ∏è";
}

/* ========= ËÉåÊôØËâ≤ ========= */
String getBackgroundColor(String wx) {
  if (wx.indexOf("Èõ∑") >= 0) return "#a2a2a2";
  if (wx.indexOf("Èõ®") >= 0) return "#87cefa";
  if (wx.indexOf("Êô¥") >= 0) return "#ffeb3b";
  return "#d3d3d3";
}

/* ========= Á©øÊê≠Âª∫Ë≠∞ËàáÈõ®ÂÖ∑ ========= */
String getClothingAdvice(int minT, int maxT, int pop, String wx) {
  String advice;
  if (minT < 15) advice = "ÂéöÂ§ñÂ•ó";
  else if (minT < 20) advice = "ËñÑÂ§ñÂ•ó";
  else if (maxT <= 28) advice = "Áü≠Ë¢ñÂç≥ÂèØ";
  else advice = "Ê∏ÖÊ∂ºÁ©øËëó";

  String umbrella;
  if (pop >= 60) umbrella = "Âª∫Ë≠∞ÊîúÂ∏∂Èõ®ÂÖ∑ ‚òî";
  else if (pop >= 30 && wx.indexOf("Èõ®") >= 0) umbrella = "ÂèØËÉΩÈôçÈõ®ÔºåÂª∫Ë≠∞ÊîúÂ∏∂Èõ®ÂÖ∑ ‚òî";
  else if (wx.indexOf("Èõ®") >= 0) umbrella = "Â§©Ê∞£‰∏çÁ©©ÂÆöÔºåÂª∫Ë≠∞ÊîúÂ∏∂Èõ®ÂÖ∑ ‚òî";
  else umbrella = "‰∏çÈúÄÊîúÂ∏∂Èõ®ÂÖ∑";

  if (pop >= 50) advice += "ÔºåË®òÂæóÂ∏∂Èõ®ÂÖ∑";
  advice += " / " + umbrella;
  return advice;
}

/* ========= ÊäìÂ§©Ê∞£ÔºàÂÖ®ÊäìÂæåÊØîÂ∞çÔºâ ========= */
bool getWeather(String city) {
  WiFiClientSecure client;
  client.setInsecure();
  HTTPClient http;

  if (!http.begin(client, baseUrl)) return false;
  if (http.GET() != HTTP_CODE_OK) return false;

  DynamicJsonDocument doc(40 * 1024);
  deserializeJson(doc, http.getString());
  http.end();

  for (JsonObject loc : doc["records"]["location"].as<JsonArray>()) {
    if (loc["locationName"].as<String>() == city) {
      for (JsonObject e : loc["weatherElement"].as<JsonArray>()) {
        String name = e["elementName"];
        String value = e["time"][0]["parameter"]["parameterName"].as<String>();
        if (name == "Wx")   wx = value;
        if (name == "PoP")  pop = value;
        if (name == "MinT") minT = value;
        if (name == "MaxT") maxT = value;
      }
      weatherIcon = getWeatherIcon(wx);
      clothingAdvice = getClothingAdvice(
        minT.toInt(), maxT.toInt(), pop.toInt(), wx
      );
      return true;
    }
  }
  return false;
}

/* ========= ‰∏ªÈ†Å ========= */
void handleRoot() {
  String html =
  "<!DOCTYPE html><html lang='zh-TW'><head>"
  "<meta charset='utf-8'>"
  "<meta name='viewport' content='width=device-width,initial-scale=1'>"
  "<title>Âè∞ÁÅ£Â§©Ê∞£</title>"
  "<style>"
  "body{font-family:sans-serif;text-align:center;transition:0.5s;}"
  "select{font-size:18px;padding:6px;margin:10px;border-radius:8px;}"
  ".card{background:#fff;padding:20px;margin:20px auto;width:90%;max-width:400px;"
  "border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.2);}"
  "h1{margin-top:20px;color:#333;}"
  "p{font-size:18px;margin:8px 0;}"
  ".icon{font-size:72px;margin:10px 0;}"
  "</style></head><body>";

  html += "<h1>Âè∞ÁÅ£ÂêÑÁ∏£Â∏ÇÂ§©Ê∞£</h1>";
  html += "<select id='citySel' onchange='loadWeather(this.value)'>";
  for (int i = 0; i < 22; i++) {
    html += "<option value='" + locationNames[i] + "'>" + locationNames[i] + "</option>";
  }
  html += "</select>";
  html += "<div id='out'></div>";

  html += "<script>"
  "function loadWeather(city){"
  "fetch('/weather?city='+city)"
  ".then(r=>r.json())"
  ".then(d=>{"
  "document.body.style.background='" + getBackgroundColor("Êô¥") + "';" // ÂàùÂßãËÉåÊôØ
  "let bg='#d3d3d3';"
  "if(d.wx.indexOf('Èõ®')>=0) bg='#87cefa';"
  "else if(d.wx.indexOf('Èõ∑')>=0) bg='#a2a2a2';"
  "else if(d.wx.indexOf('Êô¥')>=0) bg='#ffeb3b';"
  "document.body.style.background=bg;"
  "document.getElementById('out').innerHTML="
  "`<div class='card'>"
  "<h2>${city}</h2>"
  "<div class='icon'>${d.icon}</div>"
  "<p>Â§©Ê∞£Ôºö${d.wx}</p>"
  "<p>ÈôçÈõ®ÁéáÔºö${d.pop}%</p>"
  "<p>Ê∫´Â∫¶Ôºö${d.minT} ~ ${d.maxT} ¬∞C</p>"
  "<p><b>Á©øÊê≠Âª∫Ë≠∞Ôºö</b> ${d.advice.split(' / ')[0]}</p>"
  "<p><b>Èõ®ÂÖ∑Âª∫Ë≠∞Ôºö</b> ${d.advice.split(' / ')[1]}</p>"
  "</div>`;"
  "});} "
  "window.onload=function(){"
  "const sel=document.getElementById('citySel');"
  "loadWeather(sel.value);"
  "};"
  "</script></body></html>";

  server.send(200, "text/html", html);
}

/* ========= API ========= */
void handleWeather() {
  if (!server.hasArg("city")) {
    server.send(400, "text/plain", "city missing");
    return;
  }
  if (!getWeather(server.arg("city"))) {
    server.send(404, "text/plain", "not found");
    return;
  }

  String json = "{";
  json += "\"wx\":\"" + wx + "\",";
  json += "\"icon\":\"" + weatherIcon + "\",";
  json += "\"pop\":\"" + pop + "\",";
  json += "\"minT\":\"" + minT + "\",";
  json += "\"maxT\":\"" + maxT + "\",";
  json += "\"advice\":\"" + clothingAdvice + "\"}";
  server.send(200, "application/json", json);
}

/* ========= setup / loop ========= */
void setup() {
  Serial.begin(115200);
  initWiFi();
  server.on("/", handleRoot);
  server.on("/weather", handleWeather);
  server.begin();
  Serial.println("Web Server Started");
}

void loop() {
  server.handleClient();
}
